version: "3.7"
services:
  python:
    container_name: python
    build:
      context: ./python
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - game-on-paper-site
    labels:
      com.datadoghq.ad.logs: '[{"source": "fastapi", "service": "fastapi"}]'
    expose:
      - 7000
    ports:
      - 7000:7000
    healthcheck:
      test: curl --fail http://python:7000/py || exit 1
      interval: 60s
      retries: 5
      start_period: 20s
      timeout: 10s
  redis:
    container_name: redis
    build:
      context: ./redis
      dockerfile: Dockerfile.lru
    restart: unless-stopped
    networks:
      - game-on-paper-site
    labels:
      com.datadoghq.ad.logs: '[{"source": "redis", "service": "redis"}]'
    expose:
      - 6379
    ports:
      - 6379:6379
    healthcheck:
      test: redis-cli ping || exit 1
      interval: 60s
      retries: 5
      start_period: 20s
      timeout: 10s
  cache:
    container_name: cache
    build:
      context: ./redis
      dockerfile: Dockerfile.cache
    restart: unless-stopped
    networks:
      - game-on-paper-site
    labels:
      com.datadoghq.ad.logs: '[{"source": "cache", "service": "cache"}]'
    expose:
      - 6380
    ports:
      - 6380:6380
    healthcheck:
      test: redis-cli ping || exit 1
      interval: 60s
      retries: 5
      start_period: 20s
      timeout: 10s

  node:
    command: ["node","server.js"]
    container_name: node
    env_file:
      - .env
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        RDATA_BASE_URL: http://python:7000/py
    restart: unless-stopped
    networks:
      - game-on-paper-site
    labels:
      com.datadoghq.ad.logs: '[{"source": "next.js", "service": "next.js"}]'

    healthcheck:
      test: curl --fail http://node:3000/cfb/scoreboard || exit 1
      interval: 60s
      retries: 5
      start_period: 20s
      timeout: 10s
    expose:
      - 3000
    ports:
      - 3000:3000
    depends_on:
      - redis
      - cache
      - python
    links:
      - redis
      - cache
      - python

volumes:
  db_cache:
    driver: local
networks:
  game-on-paper-site: